<!DOCTYPE html>
<html>
<head>
  <title>Test</title>
</head>
<body>
  <div id="metrics" style="font: 400 normal 20px/80px sans-serif; background-color: red; margin-bottom: 30px"><!--
    --><span style="background-color: blue">A</span><!--
    --><span style="display: inline-block; height: 1px; width: 1px; background-color: yellow; vertical-align: baseline;"></span><!--
  --></div>
  <div style="position: relative; width: 200px; font-family: sans-serif; line-height: 0px; background-color: rgba(0,0,255,0.2);  margin-bottom: 20px; white-space: pre-wrap;"><!--
    --><span style="font-size: 14px; line-height: 16px; background-color: rgba(255,0,0,0.2);">This is a test of how well things size and wrap</span><!--
    --><span style="font-size: 20px; line-height: 23px; font-weight: 700; background-color: rgba(0,255,0,0.2);">, and test some more</span><!--
    --><span style="display: inline-block; vertical-align: bottom; width: 50px; height: 50px; background-color: rgba(0,0,0,0.8); position: relative; top: -0px; margin-top: 0px"></span><!--
  --></div>
  <textarea id="t" rows="10" cols="50"></textarea>
  <div id="d" style="font-family: monospace; white-space: pre-wrap; line-height: 16px; font-size: 15px;"><span id="s"></span></div>
  <script type="text/javascript">
  var boxes = [];
  function boxElement(element){
    var rects = element.getClientRects();
    var box;
    for (var i = 0, l = rects.length; i < l; ++i){
      if (i < boxes.length){
        box = boxes[i];
      }else{
        box = document.createElement('div');
        box.style.position = 'absolute';
        box.style.boxSizing = 'border-box';
        box.style.border = '1px solid red';
        document.body.appendChild(box);
      }
      box.style.top = (rects[i].top + window.pageYOffset) + 'px';
      box.style.left = (rects[i].left + window.pageXOffset) + 'px';
      box.style.width = rects[i].width + 'px';
      box.style.height = rects[i].height + 'px';
    }
    for (var j = boxes.length - 1; j >= i; --j){
      boxes[j].parentNode.removeChild(boxes[j]);
      boxes.splice(j, 1);
    }
  }
  var strlen = 10000;
  var letters = [
    'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z',
    'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',
    '.', ',', '-', '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '
  ];
  // var str = 'man\u0303ana ffi';
  // str = "\uD852\uDF62";
  // console.log(str.charCodeAt(0), str.charCodeAt(1));
  var str = "This is a\ntest of multiple lines";
  // var str = "";
  // for (var i = 0; i < strlen; ++i){
  //   str += letters[Math.floor(Math.random() * (letters.length - 1))];
  // }
  var span = document.getElementById('s');
  var t0 = new Date();
  span.appendChild(document.createTextNode(str));
  // for (var i = 0, l = str.length; i < l; ++i){
  //   span.appendChild(document.createTextNode(str.charAt(i)));
  // }
  var t1 = new Date();
  console.log(t1 - t0);
  var range = document.createRange();
  div = document.createElement('div');
  div.style.position = 'absolute';
  div.style.boxSizing = 'border-box';
  div.style.backgroundColor = 'red';
  div.style.cursor = 'text';
  document.body.appendChild(div);
  var drawRect = function(rect){
    div.style.top = rect.top + 'px';
    div.style.left = rect.left + 'px';
    div.style.width = Math.max(1, rect.width) + 'px';
    div.style.height = rect.height + 'px';
  };
  //document.caretPositionFromPoint();
  //document.caretRangeAtPoint();
  var input = document.getElementById('t');
  input.addEventListener('select', function(e){
    console.log('select', input.selectionStart, input.selectionEnd);
  });
  input.addEventListener('compositionstart', function(e){
    console.log('compositionstart', e.data);
  });
  input.addEventListener('compositionupdate', function(e){
    console.log('compositionupdate', e.data);
  });
  input.addEventListener('compositionend', function(e){
    console.log('compositionend', e.data);
  });
  input.addEventListener('input', function(e){
    console.log('input', e.data, input.value, input.selectionStart, input.selectionEnd);
  });
  input.addEventListener('beforeinput', function(e){
    console.log('beforeinput', input.selectionStart, input.selectionEnd);
  });
  s.addEventListener('mousemove', function(e){
    var x = e.clientX;
    var y = e.clientY;
    var index = indexForPoint(x, y);
    positionCursorAtIndex(index);
  });
  // abcdefg
  var indexForPoint = function(x, y){
    var min = 0;
    var max = str.length;
    var mid;
    var rects;
    var i = 0;
    while (min < max - 1 && i < 100){
      mid = Math.floor(min + (max - min) / 2);
      range.setStart(span.firstChild, mid);
      range.setEnd(span.firstChild, mid);
      rect = range.getClientRects()[0];
      if (y < rect.top){
        max = mid;
      }else if (y > rect.bottom){
        min = mid;
      }else if (x < rect.left){
        max = mid;
      }else{
        min = mid;
      }
    }
    range.setStart(span.firstChild, min);
    range.setEnd(span.firstChild, max);
    rect = range.getClientRects()[0];
    if (x < rect.left + rect.width / 2){
      return min;
    }else{
      return max;
    }
    return min;
  };
  var positionCursorAtIndex = function(index){
    range.setStart(span.firstChild, index);
    range.setEnd(span.firstChild, index);
    var rect = range.getClientRects()[0];
    drawRect(rect);
  };
  var metrics = function(e){
    var div = e.currentTarget;
    var spans = div.getElementsByTagName('span');
    input.value = "Span 1 height: " + spans[0].offsetHeight + "\n" + "Span 2 height: " + spans[1].offsetHeight + "\n" + "Span 1 offset: " + spans[0].offsetTop + "\n" + "Span 2 offset: " + spans[1].offsetTop + "\n";
  }
  document.getElementById('metrics').addEventListener('mousedown', metrics);
  </script>
</body>
</html>